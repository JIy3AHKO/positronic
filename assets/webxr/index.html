<!doctype html>
<html>
  <head>
    <meta charset='utf-8'>
    <meta name='viewport' content='width=device-width, initial-scale=1, user-scalable=no'>
    <meta name='mobile-web-app-capable' content='yes'>
    <meta name='apple-mobile-web-app-capable' content='yes'>

    <title>Input Tracking</title>
  </head>
  <body>
    <header>
      <details open>
        <summary>Input Tracking</summary>
        <p>
          This application tracks user input in an immersive AR environment using WebXR
          and sends the data to a server.
        </p>
    </header>
    <script type="module">
        import { WebXRButton } from './webxr-button.js';

        let xrButton = null;
        let xrImmersiveRefSpace = null;
        let gl = null;
        let websocket = null;

        function initXR() {
          xrButton = new WebXRButton({
            onRequestSession: onRequestSession,
            onEndSession: onEndSession
          });
          document.querySelector('header').appendChild(xrButton.domElement);

          if (navigator.xr) {
            navigator.xr.isSessionSupported('immersive-ar').then((supported) => {
              xrButton.enabled = supported;
            });

            navigator.xr.requestSession('inline').then(onSessionStarted);
          }
        }

        function initGL() {
          if (gl) return;

          let webglCanvas = document.createElement('canvas');
          gl = webglCanvas.getContext('webgl', { xrCompatible: true }) ||
               webglCanvas.getContext('experimental-webgl', { xrCompatible: true });

          if (!gl) {
            console.error('This browser does not support WebGL.');
            return;
          }

          document.body.appendChild(webglCanvas);
        }

        function onRequestSession() {
          return navigator.xr.requestSession('immersive-ar', {
            optionalFeatures: ['local-floor']
          }).then((session) => {
            xrButton.setSession(session);
            onSessionStarted(session);
          });
        }

        function onSessionStarted(session) {
          session.addEventListener('end', onSessionEnded);

          initGL();

          let glLayer = new XRWebGLLayer(session, gl);
          session.updateRenderState({ baseLayer: glLayer });

          let refSpaceType = 'local';
          session.requestReferenceSpace(refSpaceType).then((refSpace) => {
            xrImmersiveRefSpace = refSpace;
            session.requestAnimationFrame(onXRFrame);
          });
        }

        function onEndSession(session) {
          session.end();
        }

        function onSessionEnded(event) {
          if (event.session.isImmersive) {
            xrButton.setSession(null);
          }
        }

        function updateInputSources(session, frame, refSpace) {
          for (let inputSource of session.inputSources) {
            let targetRayPose = frame.getPose(inputSource.targetRaySpace, refSpace);
            if (targetRayPose && inputSource.gripSpace && inputSource.handedness === 'right') {
              let gripPose = frame.getPose(inputSource.gripSpace, refSpace);
              if (gripPose) {
                let pos = gripPose.transform.position;
                let orient = gripPose.transform.orientation;
                let buttons = inputSource.gamepad.buttons.map(button => button.value);
                sendTrackingData(pos, orient, buttons);
              }
            }
          }
        }

        function sendTrackingData(pos, orient, buttons) {
          if (websocket && websocket.readyState === WebSocket.OPEN) {
            let data = {
              position: [pos.x, pos.y, pos.z],
              orientation: [orient.w, orient.x, orient.y, orient.z],
              buttons: buttons,
              timestamp: Date.now()
            };
            websocket.send(JSON.stringify(data));
            console.log(JSON.stringify(data));
          }
        }

        function onXRFrame(t, frame) {
          let session = frame.session;
          let refSpace = xrImmersiveRefSpace;
          let pose = frame.getViewerPose(refSpace);
          session.requestAnimationFrame(onXRFrame);
          updateInputSources(session, frame, refSpace);
        }

        function initWebSocket() {
          const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
          const wsUrl = `${protocol}//${window.location.host}/ws`;
          websocket = new WebSocket(wsUrl);

          websocket.onopen = (event) => {
            console.log("WebSocket connection opened");
          };

          websocket.onclose = (event) => {
            console.log("WebSocket connection closed");
            if (event.code === 1006) {
              console.error("WebSocket connection failed. Please check if the server is running and the WebSocket endpoint is correct.");
            }
          };

          websocket.onerror = (error) => {
            console.error("WebSocket error:", error);
          };
        }

        // Start the XR application and WebSocket connection.
        initXR();
        initWebSocket();
      </script>
  </body>
</html>

